package crypto

import (
	"crypto/hmac"
	"crypto/rand"
	"crypto/rsa"
	"crypto/sha512"
	"hash"
	"io"
)

func genRandom(size int) []byte {
	r := make([]byte, size)

	_, err := rand.Read(r)
	if err != nil {
		panic(err)
	}

	return r
}

func GenKeys() (aesKey, macKey, iv []byte) {
	return genRandom(KEY_SIZE), genRandom(KEY_SIZE), genRandom(IV_SIZE)
}

func GenHeader() (Header, hash.Hash) {
	aesKey, macKey, iv := GenKeys()
	mac := hmac.New(sha512.New, macKey)

	mac.Write(aesKey)
	mac.Write(iv)

	return Header{
		MacKey: macKey,
		AesKey: aesKey,
		IV:     iv,
	}, mac
}

func WriteHeader(out io.Writer, key *rsa.PublicKey, header *Header) error {
	hd := header.Dump()
	encryptedHeader, err := RSAEncrypt(hd, key)
	if err != nil {
		return err
	}
	out.Write(encryptedHeader) // Write header

	return nil
}

func ReadHeader(in io.Reader, key *rsa.PrivateKey) (*Header, hash.Hash, error) {
	// Read encrypted header
	encryptedHeader := make([]byte, ENCRYPTED_HEADER_SIZE)
	_, err := in.Read(encryptedHeader)
	if err != nil {
		return nil, nil, err
	}

	// Decrypt the header
	h, err := RSADecrypt(encryptedHeader, key)
	if err != nil { // Invalid key or content
		return nil, nil, err
	}

	return ParseHeader(h)
}
